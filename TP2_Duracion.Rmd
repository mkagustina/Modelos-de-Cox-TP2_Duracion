---
title: |
  \vspace{1cm}
  \begin{tabular}{c}
  {\normalsize\textbf{UNIVERSIDAD NACIONAL DE ROSARIO}}\\
  {\Large Facultad de Ciencias Económicas y Estadística}\\
  \\
  \includegraphics[width=5cm]{LogoUNR.png}\\
  \vspace{1cm}
   \\
  {\huge\textbf{Análisis de datos de duración}} \\
  {\huge\textbf{en pacientes con cáncer de mama}}\\
  \\
  {\Large Rotterdam tumor bank - 1978-1985}\\
  \end{tabular}
  \vspace{5cm}
author: |
  *Alumnas:* Agustina Mac Kay y Rocio Canteros
date: "Año 2024"
output: pdf_document
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
```

## Introducción

El cáncer de mama es un tipo de cáncer primario, que se origina en la mama y puede propagarse a otros tejidos u órganos del cuerpo. Es el tipo de cáncer más frecuente y la causa más común de muerte por cáncer en mujeres a nivel mundial.[^1]

[^1]: Fuente: [\textcolor{blue}{\underline{Organización Panamericana de la Salud}}](https://www.paho.org/es/temas/cancer-mama)

En este estudio se trabajará con información acerca de 583 mujeres que fueron sometidas, entre 1978 y 1985, a una cirugía primaria para extirpar el tumor.

Los datos fueron obtenidos de la base *rotterdam* del paquete *survival* de R. La misma cuenta con el tiempo desde la cirugía hasta la muerte o pérdida de seguimiento de las pacientes, junto a otras covariables basales que se detallan a continuación:

-   **Age**: edad al momento de la cirugía (en años).
-   **Meno**: estado menopáusico, donde 0 = premenopáusico y 1 = postmenopáusico.
-   **Hormon**: variable indicadora de haber recibido un tratamiento hormonal.
-   **Chemo**: variable indicadora de haber recibido quimioterapia.
-   **Pgr**: receptores de progesterona (en fmol/l).
-   **Er**: receptores de estrógeno (en fmol/l).
-   **Grade**: grado de diferenciación del tumor, con valores de 1 a 3.
-   **Size**: tamaño del tumor, con niveles: menos de 20mm, entre 20 y 50mm, 50mm.

De la totalidad de mujeres en estudio, se cuenta con el tiempo exacto hasta la muerte de 377 de ellas y 206 censuras.

```{r echo=FALSE}
library(tidyverse)
library(gridExtra)
library(survival)  # Para el ajuste de modelos de Cox 
library(survminer) # Crear gráficos con la función ggsurvplot()
library(lmtest) # Para calcular la significancia de los Beta 
library(corrplot) #Para el gráfico de correlaciones

datos <- rotterdam %>%
  filter(year <= 1985) %>%
  select(-c(nodes, rtime, recur))

datos$grade <- as.factor(datos$grade)
```

## Selección del modelo

```{r, include=FALSE}
#Modelo sin covariables
modelo_nulo <- coxph(Surv(dtime, death) ~ 1, ties = "breslow", data = datos)
loglik_nulo <- modelo_nulo$loglik

#Modelos con una sola variable:
# 1) Edad:
modelo_edad <- coxph(Surv(dtime, death) ~ age, ties = "breslow",
                     data = datos)

loglik_edad <- modelo_edad$loglik[2]

#Comparación del modelo con el modelo nulo

lrtest(modelo_nulo, modelo_edad) # Test significativo


# 2) Menopausia
modelo_meno <- coxph(Surv(dtime, death) ~ meno, ties = "breslow",
                     data = datos)

loglik_meno <- modelo_meno$loglik[2]

#Comparo con el modelo nulo:
lrtest(modelo_nulo, modelo_meno) # Test significativo


# 3) Terapia hormonal:
modelo_hormon <- coxph(Surv(dtime, death) ~ hormon, ties = "breslow",
                       data = datos)

#Comparo con el modelo nulo:
lrtest(modelo_nulo, modelo_hormon) # Test no significativo


# 4) Quimioterapia:
modelo_chemo <- coxph(Surv(dtime, death) ~ chemo, ties = "breslow", data = datos)


#Comparo con el modelo nulo:
lrtest(modelo_nulo, modelo_chemo) # Test no significativo


# 5) Receptores de progesterona:
modelo_pgr <- coxph(Surv(dtime, death) ~ pgr, ties = "breslow",
                    data = datos)


# Comparo con el modelo nulo:
lrtest(modelo_nulo, modelo_pgr)  # Test no significativo


# 6) Receptores de estrógeno:
modelo_er <- coxph(Surv(dtime, death) ~ er, ties = "breslow",
                   data = datos)


#Comparo con el modelo nulo:
lrtest(modelo_nulo, modelo_er)  # Test significativo



# 7) Grado de diferenciación:
modelo_grade <- coxph(Surv(dtime, death) ~ grade, ties = "breslow",
                      data = datos)


# Compraro con el modelo nulo:
lrtest(modelo_nulo, modelo_grade)  #Test significativo


# 8) Tamaño del tumor:
modelo_size <- coxph(Surv(dtime, death) ~ size, ties = "breslow",
                     data = datos)


#Comparación con el modelo nulo:
lrtest(modelo_nulo, modelo_size) #Test significativo

# En resumen, resultaron significativos: edad, menopausia, receptores de estrógeno, grado de diferenciación y tamaño del tumor.
```

En primer lugar se compara, para cada variable, su modelo univariado contra un modelo sin covariables. Las hipótesis en contraste son:

\begin{align*}
\begin{cases}
H_0) \quad &\beta_j = 0 \\
&\qquad \qquad \quad \text{con} \; j = \overline{1,8} \\
H_1) \quad &\beta_j \neq 0
\end{cases}
\end{align*}

Los resultados obtenidos son los siguientes:

$$
\begin{array}{c|c|c}
\text{Variable} & p\,\text{-value} & \text{Decisión}\\
\hline
\text{Edad} & 0.0000 & \text{Rechazo H}_0\\
\text{Menopausia} & 0.0000 & \text{Rechazo H}_0\\
\text{Tratamiento hormonal} & 0.8381 & \text{No rechazo H}_0\\
\text{Quimioterapia} & 0.4217 & \text{No rechazo H}_0\\
\text{Receptores de progesterona} & 0.1316 & \text{No rechazo H}_0\\
\text{Receptores de estrógeno} & 0.0017 & \text{Rechazo H}_0\\
\text{Grado de diferenciación} & 0.0004 & \text{Rechazo H}_0\\
\text{Tamaño} & 0.0000 & \text{Rechazo H}_0
\end{array}
$$

Se determina entonces que las variables significativas en esta etapa de la selección de variables son: Edad, Menopausia, Receptores de estrógeno, Grado de diferenciación y Tamaño del tumor. 

En segundo lugar, se evaluará si cada una de esas variables siguen siendo significativas en presencia de las demás.

Para cada variable, se compara un modelo aditivo que contenga todas las variables significativas hasta el momento, excepto la variable en cuestión, contra un modelo que contenga todas las variables significativas.

Previo a esta comparación de modelos, se definen 2 *dummies* referentes a la variable *Tamaño* y otras 2 para la variable *Grado*:

\[
\begin{array}{ccc|ccc}
\text{size} & S_1 & S_2 & \text{grade} & G_1 & G_2 \\
\hline
< 20 & 0 & 0 & 1 & 0 & 0 \\
20\text{-}50 & 1 & 0 & 2 & 1 & 0 \\
> 50 & 0 & 1 & 3 & 0 & 1 \\
\end{array}
\]


- Modelo aditivo: 

$$
h_i(t) = h_0(t) \cdot \exp(\beta_1 \cdot \text{edad}_i + \beta_2 \cdot \text{meno}_i + \beta_3 \cdot \text{er}_i + \beta_4 \cdot G_{1i} + \beta_5 \cdot G_{2i} + \beta_6 \cdot S_{1i} + \beta_7 \cdot S_{2i})
$$

- Modelos de comparación:

1) Sin la variable *Edad*: 

$$h_i(t) = h_0(t) \cdot \exp(\beta_2 \cdot \text{meno}_i + \beta_3 \cdot \text{er}_i + \beta_4 \cdot G_{1i} + \beta_5 \cdot G_{2i} + \beta_6 \cdot S_{1i} + \beta_7 \cdot S_{2i})$$

2) Sin la variable *Menopausia*: 

$$h_i(t) = h_0(t) \cdot \exp(\beta_1 \cdot \text{edad}_i + \beta_3 \cdot \text{er}_i + \beta_4 \cdot G_{1i} + \beta_5 \cdot G_{2i} + \beta_6 \cdot S_{1i} + \beta_7 \cdot S_{2i})$$

3) Sin la variable *Receptores de estrógeno*: 

$$h_i(t) = h_0(t) \cdot \exp(\beta_1 \cdot \text{edad}_i + \beta_2 \cdot \text{meno}_i + \beta_4 \cdot G_{1i} + \beta_5 \cdot G_{2i} + \beta_6 \cdot S_{1i} + \beta_7 \cdot S_{2i})$$

4) Sin la variable *Grado de diferenciación del tumor*: 

$$h_i(t) = h_0(t) \cdot \exp(\beta_1 \cdot \text{edad}_i + \beta_2 \cdot \text{meno}_i + \beta_3 \cdot \text{er}_i + \beta_6 \cdot S_{1i} + \beta_7 \cdot S_{2i})$$

5) Sin la variable *Tamaño del tumor*: 

$$h_i(t) = h_0(t) \cdot \exp(\beta_1 \cdot \text{edad}_i + \beta_2 \cdot \text{meno}_i + \beta_3 \cdot \text{er}_i + \beta_4 \cdot G_{1i} + \beta_5 \cdot G_{2i})$$
## ARREGLAR ESSTO
\underline{Hipótesis}: las hipótesis del test para la $j$-ésima variable es:

\begin{align*}
\begin{cases}
H_0) \quad &\beta_j = 0 \\
&\qquad \qquad \quad \text{con} \; j = \overline{1,7} \\
H_1) \quad &\beta_j \neq 0
\end{cases}
\end{align*}
   
```{r, include=FALSE}
#Se define el modelo con las variables importantes:
modelo1 <- coxph(Surv(dtime, death) ~ age + meno + er + grade + size,
                 ties = "breslow", data = datos)

# Para cada variable importante, comparamos el modelo 1 contra un modelo que no contenga la variable de interés y así evaluamos su significancia

# 1) Variable Edad
modelo_sin_age <- coxph(Surv(dtime, death) ~ meno + er + grade + size,
                        ties = "breslow", data = datos)

lrtest(modelo_sin_age, modelo1) # Test significativo

# 2) Variable Menopausia
modelo_sin_meno <- coxph(Surv(dtime, death) ~ age + er + grade + size,
                         ties = "breslow", data = datos)

lrtest(modelo_sin_meno, modelo1) # Test no significativo

# 3) Variable Receptores de estrógeno
modelo_sin_er <- coxph(Surv(dtime, death) ~ age + meno + grade + size,
                       ties = "breslow", data = datos)

lrtest(modelo_sin_er, modelo1) # Test no significativo

# 4) Variable Grade
modelo_sin_grade <- coxph(Surv(dtime, death) ~ age + meno + er + size,
                          ties = "breslow", data = datos)

lrtest(modelo_sin_grade, modelo1) # Test significativo

# 5) Variable Size
modelo_sin_size <- coxph(Surv(dtime, death) ~ age + meno + er + grade,
                         ties = "breslow", data = datos)

lrtest(modelo_sin_size, modelo1) # Test significativo

# En resumen, las variables que resultaron significativas en un modelo que contiene la edad, menopausia, receptores de estrógeno, grado y tamaño del tumor son: edad, grado y tamaño del tumor.
```
Teniendo en cuenta que los resultados de las comparaciones de los modeloes fueron los siguientes:

$$
\begin {array} {c|c|c}
\text{Variable} & p\,\text{-value} & \text{Decisión} \\
\hline
\text{Edad} & 0.0229 & \text{Rechazo H}_0 \\
\text{Menopausia} & 0.5586 & \text{No rechazo H}_0 \\
\text{Receptores de estrógeno} & 0.1276 & \text{No rechazo H}_0 \\
\text{Grado de diferenciación} & 0.0056 & \text{Rechazo H}_0 \\
\text{Tamaño} & \sim 0 & \text{Rechazo H}_0 \\
\end {array}
$$

El modelo que se obtendría sería $h_i(t) = h_0(t) \cdot \exp(\beta_1 \cdot \text{edad}_i + \beta_2 \cdot G_{1i} + \beta_3 \cdot G_{2i} + \beta_4 \cdot S_{1i} + \beta_5 \cdot S_{2i})$. Sin embargo, este no es el modelo final dado que falta evaluar si ahora, con otras variables en el modelo, aquellas que no resultaron significativas de manera univariada lo son.

```{r, include=FALSE}
# Modelo con las variables significativas hasta el momento
modelo2 <- coxph(Surv(dtime, death) ~ age + grade + size, ties = "breslow",
                 data = datos)

# Para evaluar la significancia de las covariables que descartamos en la primer etapa de la selección,comparamos el modelo 2 contra un modelo que contenga sus mismas variables más cada una de las covariables.

# 1) Variable "Tratamiento hormonal"
modelo2_con_hormon <- coxph(Surv(dtime, death) ~ age + grade + size +
                              hormon, ties = "breslow", data = datos)
 
 lrtest(modelo2, modelo2_con_hormon) # Test no significativo
 
# 2) Variable Quimioterapia
modelo2_con_chemo <- coxph(Surv(dtime, death) ~ age + grade + size + chemo,
                           ties = "breslow", data = datos)
 
lrtest(modelo2, modelo2_con_chemo) # Test significativo

# 3) Variable Receptores de progesterona:
modelo2_con_pgr <- coxph(Surv(dtime, death) ~ age + grade + size + pgr, 
                         ties = "breslow", data = datos)
 
lrtest(modelo2, modelo2_con_pgr) #No es significativa

# En resumen, el efecto de la Quimioterapia es significativo en un modelo que incluye también a la edad y el grado y tamaño del tumor. Tratamiento hormonal y Receptores de Progesterona siguen sin ser significativos.

# Llamamos "modelo 3" a nuestro nuevo modelo
modelo3 <- coxph(Surv(dtime, death) ~ age + chemo + grade + size,
                 ties = "breslow", data = datos)
```
Nuevamente se analizan los resultados brindados por la comparación entre los modelos:

$$ \begin{array} {c|c|c}
\text{Variable} & p\,\text{-value} & \text{Decisión} \\
\hline
\text{Tratamiento hormonal} & 0.5420 & \text{No rechazo H}_0 \\
\text{Quimioterapia} & 0.0209 & \text{Rechazo H}_0 \\
\text{Receptores de progesterona} & 0.3811 & \text{No rechazo H}_0 \\
\end{array} $$

De esta manera, el modelo final sería $h_i(t) = h_0(t) \cdot \exp(\beta_1 \cdot \text{edad}_i + \beta_2 \cdot \text{chemo}_i + \beta_3 \cdot G_{1i} + \beta_4 \cdot G_{2i} + \beta_5 \cdot S_{1i} + \beta_6 \cdot S_{2i})$


## Linealidad

Cuando se tienen variables de tipo continua debe analizarse en qué forma se las incluye en el modelo y hay dos opciones para ello: lineal y no lineal; esta última contempla tanto la idea de categorizar la variable como la de trabajar con una función de ella (logaritmo, al cuadrado, etc).
Las hipótesis que se plantean son:

\begin{align*}
H_0)\quad &\text{El efecto de Edad es lineal} \\
H_1)\quad &\text{El efecto de Edad NO es lineal}
\end{align*}

```{r, eval = FALSE}
# Variable Edad
datos2 <- datos %>% 
  mutate(
    age_d1 = ifelse(age >= 40 & age < 50, 1, 0),
    age_d2 = ifelse(age >= 50 & age < 70, 1, 0),
    age_d3 = ifelse(age >= 70, 1, 0)
  ) %>% 
  mutate(
    age_factor = case_when(
      age < 40 ~ 1,
      age >= 40 & age < 50 ~ 2,
      age >= 50 & age < 70 ~ 3,
      age >= 70 ~ 4
    )
  )

modelo3_edad_dummie <- coxph(Surv(dtime, death) ~ age_d1 + age_d2 + age_d3
                             + chemo + grade + size, ties = "breslow",
                             data = datos2)

modelo3_edad_factor <- coxph(Surv(dtime, death) ~ age_factor + chemo + grade + size, ties = "breslow", data = datos2)

lrtest(modelo3_edad_factor, modelo3_edad_dummie) # Test no significativo
```

La probabilidad asociada es mayor al 5%, entonces la variable es lineal.
Con este resultado, se concluye que el modelo definitivo es el presentado con anterioridad:
$$
h_i(t) = h_0(t) \cdot \exp(\beta_1 \cdot \text{edad}_i + \beta_2 \cdot \text{chemo}_i + \beta_3 \cdot G_{1i} + \beta_4 \cdot G_{2i} + \beta_5 \cdot S_{1i} + \beta_6 \cdot S_{2i})
$$

## Comprobación de supuestos

Como es sabido, todo el trabajo realizado se desarrolló suponiendo que los hazards son proporcionales pero ¿Se cumple esto?
Se comprabará de mediante el uso de los residuos de Schoenfeld obtenidos para cada variable
```{r}
#H_0)Los hazards son proporcionales
test <- cox.zph(modelo3)
kableExtra::kable(test$table, col.names = c("Chi-cuadrado", "g.l", "p-asoc"))


#Convertimos la información de "test" en datos que puedan usarse en ggplot()
time <- test$x
residuals <- as.data.frame(test$y)
variables <- c("Edad", "Quimioterapia", "Grado", "Tamaño")

data <- data.frame(
  time = rep(time, ncol(residuals)),
  residuals =as.vector(as.matrix(residuals)),
  variable = rep(variables, each = length(time))
)

#Gráfico de residuos
ggplot(data = data, aes(x = time, y = residuals)) +
  geom_point(pch = 21, color = "black") +
  geom_smooth(method = "loess", se = F, color = "steelblue2") +
  facet_wrap(~variable, scales = "free_y")+
  labs(x = "Tiempo", y = "Residuos", caption = "Gráfico : Evaluación de la proporcionalidad") +
  theme_bw()
```


La función `cox.zph()`, de manera global, dice que el supuesto no es cierto ya que se rechaza la hipotesis nula y además brinda información acerca de cuales variables no estarían cumpliento la proporcionalidad: *Edad* y *Quimioterapia*. Esto puede constatarse de forma gráfica al ver que los residuos de esas 2 variables no siguen un patrón de paralelismo como la hacen los residuos de *Tamaño* y *Grado*. (REVISAR ESTA REDACCIÓN)